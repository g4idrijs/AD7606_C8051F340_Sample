C51 COMPILER V9.01   MAIN                                                                  05/27/2015 21:20:14 PAGE 1   


C51 COMPILER V9.01, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN MAIN.OBJ
COMPILER INVOKED BY: C:\Keil\C51\BIN\C51.EXE MAIN.c LARGE BROWSE DEBUG OBJECTEXTEND

line level    source

   1          #include "compiler_defs.h"
   2          #include <c8051f340.h>
   3          #include <stddef.h>
   4          #include <stdio.h>
   5          #include "USB_API.h"
   6          
   7          /*** [BEGIN] USB Descriptor Information [BEGIN] ***/
   8          code const UINT USB_VID = 0x10C4;                                                               
   9          code const UINT USB_PID = 0xEA61;
  10          code const BYTE USB_MfrStr[] = {0x1A,0x03,'S',0,'i',0,'l',0,'i',0,'c',0,'o',0,'n',0,' ',0,'L',0,'a',0,'b',
             -0,'s',0};
  11          code const BYTE USB_ProductStr[] = {0x10,0x03,'U',0,'S',0,'B',0,' ',0,'A',0,'P',0,'I',0};
  12          code const BYTE USB_SerialStr[] = {0x0A,0x03,'i',0,'d',0,'r',0,'i',0};
  13          code const BYTE USB_MaxPower = 15;
  14          code const BYTE USB_PwAttributes = 0x80; // Bus-powered, remote wakeup not supported
  15          code const UINT USB_bcdDevice = 0x0100;
  16          /*** [ END ] USB Descriptor Information [ END ] ***/
  17          
  18          /*** [BEGIN]  [BEGIN] ***/
  19          sbit CS_RD=P0^0;
  20          sbit CONVSTAB=P0^1;
  21          sbit BUSY=P0^6;
  22          sbit REST=P0^7;
  23          sbit OA=P2^4;
  24          sbit OB=P2^5;
  25          sbit OC=P2^6;
  26          sbit RAGE= P2^7;
  27          sbit Led = P2^3;
  28          /*** [ END ]  [ END ] ***/
  29          
  30          /*** [BEGIN]  [BEGIN] ***/
  31          sfr16 TMR2RL = 0xca; // Timer2 reload value 
  32          sfr16 TMR2 = 0xcc; // Timer2 counter
  33          
  34          #define SYSCLK 24000000
  35          #define TIMER_PRESCALER 12  // Based on Timer2 CKCON and TMR2CN settings
  36          #define RATE    50000
  37          // There are SYSCLK/TIMER_PRESCALER timer ticks per second, so
  38          // SYSCLK/TIMER_PRESCALER timer ticks per second.
  39          #define TIMER_TICKS_PER_S  SYSCLK/TIMER_PRESCALER
  40          // NoteRATE*TIMER_TICKS_PERS should not exceed 65535 (0xFFFF)for the 16-bit timer
  41          #define AUX1 TIMER_TICKS_PER_S/RATE
  42          /*** [ END ]  [ END ] ***/
  43          
  44          /*** [BEGIN]  [BEGIN] ***/
  45          #define N 16
  46          U8 Busy;
  47          U8 xdata out1[N];
  48          U8 xdata out2[N];
  49          U16 T1;
  50          U16 T2;
  51          U8 Flag1;
  52          U8 Flag2;
  53          U16 i;
  54          /*** [ END ]  [ END ] ***/
C51 COMPILER V9.01   MAIN                                                                  05/27/2015 21:20:14 PAGE 2   

  55          
  56          /*** [BEGIN]  [BEGIN] ***/
  57          void Oscilitator_Init(void);
  58          void Port_Init(void);
  59          void Suspend_Device(void);
  60          void Delay(void);       
  61          void AD7606_Init(void);
  62          void AD7606_Read(void);
  63          void Timer2_Init(U16 counts);
  64          void Timer2_ISR (void);
  65          /*** [ END ]  [ END ] ***/
  66          
  67          void main(void)
  68          {
  69   1              PCA0MD &= ~0x40;
  70   1      
  71   1              Oscilitator_Init();
  72   1              Port_Init(); 
  73   1              USB_Clock_Start();
  74   1              CLKSEL |= 0x02;
  75   1              USB_Init(USB_VID,USB_PID,USB_MfrStr,USB_ProductStr,USB_SerialStr,USB_MaxPower,USB_PwAttributes,USB_bcdDev
             -ice);   
  76   1      
  77   1              AD7606_Init();
  78   1              USB_Int_Enable();
  79   1              T1=0;T2=0;Flag1=1;Flag2=0;
  80   1              Timer2_Init(AUX1); 
  81   1              Led=0;
  82   1              EA = 1;
  83   1              IP=0x20;                 
  84   1      
  85   1              while (1)
  86   1              {
  87   2                      if(Flag1==1)
  88   2                      {
  89   3                              Block_Write(out1,N);
  90   3                              Flag1=0;
  91   3                              Flag2=0;
  92   3                      }
  93   2                      if(Flag2==1)
  94   2                      {
  95   3                              Block_Write(out2,N);
  96   3                              Flag1=0;
  97   3                              Flag2=0;
  98   3                      }       
  99   2              }
 100   1      }
 101          
 102          
 103          void AD7606_Init()
 104          {
 105   1              Delay();
 106   1              REST=0;
 107   1              OA=0;OB=0;OC=0;RAGE=0;
 108   1              CS_RD=1;
 109   1              CONVSTAB=0;
 110   1              REST=1;
 111   1              Delay();
 112   1              REST=0; 
 113   1      }
 114          
 115          void AD7606_Read()
C51 COMPILER V9.01   MAIN                                                                  05/27/2015 21:20:14 PAGE 3   

 116          {
 117   1              CS_RD=0;
 118   1      
 119   1              if(Flag1==0)
 120   1              {
 121   2                      out1[T1]=P3;
 122   2                      T1=T1+1;
 123   2                      out1[T1]=P1;
 124   2                      T1=T1+1;
 125   2                      if(T1==N)
 126   2                      {
 127   3                              Flag1=1;
 128   3                              T1=0;
 129   3                      }
 130   2              }
 131   1              if(Flag2==0)
 132   1              {
 133   2                      out2[T2]=P3;
 134   2                      T2=T2+1;
 135   2                      out2[T2]=P1;
 136   2                      T2=T2+1;
 137   2                      if(T2==N)
 138   2                      {
 139   3                              Flag2=1;
 140   3                              T2=0;
 141   3                      }
 142   2              }
 143   1      
 144   1              CS_RD=1;
 145   1              CONVSTAB=0;     
 146   1      
 147   1              CONVSTAB=1;             
 148   1      }
 149          
 150          void Oscilitator_Init()
 151          {
 152   1              CLKMUL = 0x80;
 153   1          for (i = 0; i < 20; i++);
 154   1          CLKMUL |= 0xC0;
 155   1          while ((CLKMUL & 0x20) == 0);
 156   1          OSCICN = 0x83;
 157   1              CLKSEL |= 0x02; 
 158   1      }
 159          
 160          void Timer2_Init(U16 counts)
 161          {
 162   1         TMR2CN  = 0x00;                     // Stop Timer2; Clear TF2;
 163   1                                             // Use SYSCLK/12 as timebase
 164   1         CKCON  &= ~0x60;                    // Timer2 clocked based on T2XCLK;
 165   1      
 166   1         TMR2RL  = -counts;                  // Init reload values
 167   1         TMR2    = 0xffff;                   // Set to reload immediately
 168   1         ET2     = 1;                        // Enable Timer2 interrupts
 169   1         TR2     = 1;                        // Start Timer2
 170   1      }
 171          
 172          void Port_Init(void)
 173          {
 174   1              P0MDIN |= 0x40;
 175   1              P0MDOUT = 0xcc; 
 176   1              P1MDIN |= 0xff; 
 177   1              P1MDOUT = 0x00;
C51 COMPILER V9.01   MAIN                                                                  05/27/2015 21:20:14 PAGE 4   

 178   1              P1 |= 0xff;
 179   1              P2MDOUT = 0xfb;
 180   1              P3MDIN |= 0xff; 
 181   1              P3MDOUT = 0x00;
 182   1              P3 |= 0xff;               
 183   1      
 184   1              XBR0 = 0x01;
 185   1              XBR1 = 0x40;
 186   1      }
 187          
 188          void Suspend_Device(void)
 189          {
 190   1         USB_Suspend();
 191   1      
 192   1      }
 193          
 194          void  USB_API_TEST_ISR(void) interrupt 17
 195          {
 196   1         BYTE INTVAL = Get_Interrupt_Source();
 197   1      
 198   1         if (INTVAL & DEV_SUSPEND)
 199   1         {
 200   2              Suspend_Device();
 201   2         }
 202   1      
 203   1         if (INTVAL & DEV_CONFIGURED)
 204   1         {
 205   2                      Port_Init();
 206   2         }
 207   1      }
 208          
 209          void Timer2_ISR (void) interrupt 5
 210          {
 211   1              Led=~Led;
 212   1              TF2H = 0; // Clear Timer2 interrupt flag
 213   1              AD7606_Read();
 214   1      }
 215          
 216          void Delay (void)
 217          {
 218   1         int x;
 219   1         for(x = 0;x < 500;x)
 220   1            x++;
 221   1      }
 222          
 223          void delay_us(unsigned char T)
 224          {
 225   1              unsigned char xdata i;
 226   1          while(T--)
 227   1              {
 228   2                      for(i=6;i>0;i--);         
 229   2              }
 230   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    667    ----
   CONSTANT SIZE    =     60    ----
   XDATA SIZE       =     41       1
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
C51 COMPILER V9.01   MAIN                                                                  05/27/2015 21:20:14 PAGE 5   

   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
