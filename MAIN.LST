C51 COMPILER V9.01   MAIN                                                                  05/26/2015 00:51:08 PAGE 1   


C51 COMPILER V9.01, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN MAIN.OBJ
COMPILER INVOKED BY: C:\Keil\C51\BIN\C51.EXE MAIN.c LARGE BROWSE DEBUG OBJECTEXTEND

line level    source

   1          #include "compiler_defs.h"
   2          #include <c8051f340.h>
   3          #include <stddef.h>
   4          #include <stdio.h>
   5          #include "USB_API.h"
   6          
   7          /*** [BEGIN] USB Descriptor Information [BEGIN] ***/
   8          code const UINT USB_VID = 0x10C4;                                                               
   9          code const UINT USB_PID = 0xEA61;
  10          code const BYTE USB_MfrStr[] = {0x1A,0x03,'S',0,'i',0,'l',0,'i',0,'c',0,'o',0,'n',0,' ',0,'L',0,'a',0,'b',
             -0,'s',0};
  11          code const BYTE USB_ProductStr[] = {0x10,0x03,'U',0,'S',0,'B',0,' ',0,'A',0,'P',0,'I',0};
  12          code const BYTE USB_SerialStr[] = {0x0A,0x03,'i',0,'d',0,'r',0,'i',0};
  13          code const BYTE USB_MaxPower = 15;
  14          code const BYTE USB_PwAttributes = 0x80; // Bus-powered, remote wakeup not supported
  15          code const UINT USB_bcdDevice = 0x0100;
  16          /*** [ END ] USB Descriptor Information [ END ] ***/
  17          
  18          /*** [BEGIN]  [BEGIN] ***/
  19          sbit CS_RD=P0^0;
  20          sbit CONVSTAB=P0^1;
  21          sbit BUSY=P0^6;
  22          sbit REST=P0^7;
  23          sbit OA=P2^4;
  24          sbit OB=P2^5;
  25          sbit OC=P2^6;
  26          sbit RAGE= P2^7;
  27          sbit Led = P2^3;
  28          /*** [ END ]  [ END ] ***/
  29          
  30          /*** [BEGIN]  [BEGIN] ***/
  31          sfr16 TMR2RL = 0xca; // Timer2 reload value 
  32          sfr16 TMR2 = 0xcc; // Timer2 counter
  33          
  34          #define SYSCLK 24000000
  35          #define TIMER_PRESCALER 12  // Based on Timer2 CKCON and TMR2CN settings
  36          #define RATE    50000
  37          // There are SYSCLK/TIMER_PRESCALER timer ticks per second, so
  38          // SYSCLK/TIMER_PRESCALER timer ticks per second.
  39          #define TIMER_TICKS_PER_S  SYSCLK/TIMER_PRESCALER
  40          // NoteRATE*TIMER_TICKS_PERS should not exceed 65535 (0xFFFF)for the 16-bit timer
  41          #define AUX1 TIMER_TICKS_PER_S/RATE
  42          /*** [ END ]  [ END ] ***/
  43          
  44          /*** [BEGIN]  [BEGIN] ***/
  45          #define N 16
  46          U8 Busy;
  47          U8 xdata out1[N];
  48          U8 xdata out2[N];
  49          U16 T1;
  50          U16 T2;
  51          U8 Flag1;
  52          U8 Flag2;
  53          U16 i;
  54          /*** [ END ]  [ END ] ***/
C51 COMPILER V9.01   MAIN                                                                  05/26/2015 00:51:08 PAGE 2   

  55          
  56          /*** [BEGIN]  [BEGIN] ***/
  57          void Oscilitator_Init(void);
  58          void Port_Init(void);
  59          void Suspend_Device(void);
  60          void Delay(void);       
  61          void AD7606_Init(void);
  62          void AD7606_Read(void);
  63          void Timer2_Init(U16 counts);
  64          void Timer2_ISR (void);
  65          void Ext_Interrupt_Init();
  66          /*** [ END ]  [ END ] ***/
  67          
  68          void main(void)
  69          {
  70   1              PCA0MD &= ~0x40;
  71   1      
  72   1              Oscilitator_Init();
  73   1              Port_Init(); 
  74   1              USB_Clock_Start();
  75   1              CLKSEL |= 0x02;
  76   1              USB_Init(USB_VID,USB_PID,USB_MfrStr,USB_ProductStr,USB_SerialStr,USB_MaxPower,USB_PwAttributes,USB_bcdDev
             -ice);   
  77   1      
  78   1              AD7606_Init();
  79   1              USB_Int_Enable();
  80   1              T1=0;T2=0;Flag1=1;Flag2=0;
  81   1              Timer2_Init(AUX1); 
  82   1              Ext_Interrupt_Init();
  83   1              Led=0;
  84   1              EA = 1;
  85   1              //IE=0xA1;
  86   1              IP=0x21;
  87   1                       
  88   1      
  89   1              while (1)
  90   1              {
  91   2                      if(Flag1==1)
  92   2                      {
  93   3                              Block_Write(out1,N);
  94   3                              Flag1=0;
  95   3                              Flag2=0;
  96   3                      }
  97   2                      if(Flag2==1)
  98   2                      {
  99   3                              Block_Write(out2,N);
 100   3                              Flag1=0;
 101   3                              Flag2=0;
 102   3                      }       
 103   2              }
 104   1      }
 105          
 106          
 107          void AD7606_Init()
 108          {
 109   1              Delay();
 110   1              REST=0;
 111   1              OA=0;OB=0;OC=0;RAGE=0;
 112   1              CS_RD=1;
 113   1              CONVSTAB=0;
 114   1              REST=1;
 115   1              Delay();
C51 COMPILER V9.01   MAIN                                                                  05/26/2015 00:51:08 PAGE 3   

 116   1              REST=0; 
 117   1      }
 118          
 119          void AD7606_Read()
 120          {
 121   1              CONVSTAB=1;             
 122   1      }
 123          
 124          void Oscilitator_Init()
 125          {
 126   1              CLKMUL = 0x80;
 127   1          for (i = 0; i < 20; i++);
 128   1          CLKMUL |= 0xC0;
 129   1          while ((CLKMUL & 0x20) == 0);
 130   1          OSCICN = 0x83;
 131   1              CLKSEL |= 0x02; 
 132   1      }
 133          
 134          void Timer2_Init(U16 counts)
 135          {
 136   1         TMR2CN  = 0x00;                     // Stop Timer2; Clear TF2;
 137   1                                             // Use SYSCLK/12 as timebase
 138   1         CKCON  &= ~0x60;                    // Timer2 clocked based on T2XCLK;
 139   1      
 140   1         TMR2RL  = -counts;                  // Init reload values
 141   1         TMR2    = 0xffff;                   // Set to reload immediately
 142   1         ET2     = 1;                        // Enable Timer2 interrupts
 143   1         TR2     = 1;                        // Start Timer2
 144   1      }
 145          
 146          void Port_Init(void)
 147          {
 148   1              P0MDIN |= 0x40;
 149   1              P0MDOUT = 0xcc; 
 150   1              P1MDIN |= 0xff; 
 151   1              P1MDOUT = 0x00;
 152   1              P1 |= 0xff;
 153   1              P2MDOUT = 0xfb;
 154   1              P3MDIN |= 0xff; 
 155   1              P3MDOUT = 0x00;
 156   1              P3 |= 0xff;               
 157   1      
 158   1              XBR0 = 0x01;
 159   1              XBR1 = 0x40;
 160   1      }
 161          
 162          void Ext_Interrupt_Init (void)
 163          {
 164   1         TCON = 0x03;
 165   1         IT01CF = 0x06; 
 166   1         EX0 = 1; 
 167   1      }
 168          
 169          void INT0_ISR (void) interrupt 0
 170          {
 171   1              CS_RD=0;
 172   1              if(Flag1==0)
 173   1              {
 174   2                      out1[T1]=P3;
 175   2                      T1=T1+1;
 176   2                      out1[T1]=P1;
 177   2                      T1=T1+1;
C51 COMPILER V9.01   MAIN                                                                  05/26/2015 00:51:08 PAGE 4   

 178   2                      if(T1==N)
 179   2                      {
 180   3                              Flag1=1;
 181   3                              T1=0;
 182   3                      }
 183   2              }
 184   1              if(Flag2==0)
 185   1              {
 186   2                      out2[T2]=P3;
 187   2                      T2=T2+1;
 188   2                      out2[T2]=P1;
 189   2                      T2=T2+1;
 190   2                      if(T2==N)
 191   2                      {
 192   3                              Flag2=1;
 193   3                              T2=0;
 194   3                      }
 195   2              }
 196   1              CS_RD=1;
 197   1              CONVSTAB=0;     
 198   1      }
 199          
 200          void Suspend_Device(void)
 201          {
 202   1         USB_Suspend();
 203   1      
 204   1      }
 205          
 206          void  USB_API_TEST_ISR(void) interrupt 17
 207          {
 208   1         BYTE INTVAL = Get_Interrupt_Source();
 209   1      
 210   1         if (INTVAL & DEV_SUSPEND)
 211   1         {
 212   2              Suspend_Device();
 213   2         }
 214   1      
 215   1         if (INTVAL & DEV_CONFIGURED)
 216   1         {
 217   2                      Port_Init();
 218   2         }
 219   1      }
 220          
 221          void Timer2_ISR (void) interrupt 5
 222          {
 223   1              Led=~Led;
 224   1              TF2H = 0; // Clear Timer2 interrupt flag
 225   1              AD7606_Read();
 226   1      }
 227          
 228          void Delay (void)
 229          {
 230   1         int x;
 231   1         for(x = 0;x < 500;x)
 232   1            x++;
 233   1      }
 234          
 235          void delay_us(unsigned char T)
 236          {
 237   1              unsigned char xdata i;
 238   1          while(T--)
 239   1              {
C51 COMPILER V9.01   MAIN                                                                  05/26/2015 00:51:08 PAGE 5   

 240   2                      for(i=6;i>0;i--);         
 241   2              }
 242   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    680    ----
   CONSTANT SIZE    =     60    ----
   XDATA SIZE       =     41       1
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
