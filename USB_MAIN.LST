C51 COMPILER V9.01   USB_MAIN                                                              05/05/2015 11:38:19 PAGE 1   


C51 COMPILER V9.01, COMPILATION OF MODULE USB_MAIN
OBJECT MODULE PLACED IN USB_MAIN.OBJ
COMPILER INVOKED BY: C:\Keil\C51\BIN\C51.EXE USB_MAIN.c BROWSE DEBUG OBJECTEXTEND

line level    source

   1          #include <c8051f340.h>
   2          #include <stddef.h>
   3          #include "USB_API.h"
   4          #include "C8051F340_AD7606.h"
   5          #include "stdio.h"
   6                                                                                                                                                                                                                  
   7          sbit Led = P2^3;
   8          unsigned char Out_Packet[16]; // Last packet received from host
   9          unsigned char In_Packet[2]; // Last packet received from host
  10          extern unsigned char Data[16];
  11          unsigned char Ax[32] ={1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31
             -,32};
  12          unsigned char i;
  13          
  14          /*** [BEGIN] USB Descriptor Information [BEGIN] ***/
  15          code const UINT USB_VID = 0x10C4;                                                               
  16          code const UINT USB_PID = 0xEA61;
  17          code const BYTE USB_MfrStr[] = {0x1A,0x03,'S',0,'i',0,'l',0,'i',0,'c',0,'o',0,'n',0,' ',0,'L',0,'a',0,'b',
             -0,'s',0};
  18          code const BYTE USB_ProductStr[] = {0x10,0x03,'U',0,'S',0,'B',0,' ',0,'A',0,'P',0,'I',0};
  19          code const BYTE USB_SerialStr[] = {0x0A,0x03,'i',0,'d',0,'r',0,'i',0};
  20          code const BYTE USB_MaxPower = 15;
  21          code const BYTE USB_PwAttributes = 0x80; // Bus-powered, remote wakeup not supported
  22          code const UINT USB_bcdDevice = 0x0100;
  23          /*** [ END ] USB Descriptor Information [ END ] ***/
  24          
  25          void Oscillator_Init();
  26          void Port_Init(void);
  27          void Suspend_Device(void);
  28          
  29          void main(void)
  30          {
  31   1         PCA0MD &= ~0x40;
  32   1         Oscillator_Init();
  33   1         Port_Init();
  34   1         USB_Clock_Start();
  35   1         USB_Init(USB_VID,USB_PID,USB_MfrStr,USB_ProductStr,USB_SerialStr,USB_MaxPower,USB_PwAttributes,USB_bcdD
             -evice);
  36   1         USB_Int_Enable();
  37   1      
  38   1         //AD7606_Init();
  39   1         
  40   1         while (1)
  41   1         {
  42   2            if (In_Packet[0] == 1) Led = 1;
  43   2            else Led = 0;
  44   2                //AD7606_Read();
  45   2                /*for(i=0;i<32;i++)
  46   2                {
  47   2                Out_Packet[i] = Data[i];
  48   2                }*/     
  49   2      
  50   2                //Block_Write(Data, 16);
  51   2                Block_Write(Ax, 32);      
  52   2         }
C51 COMPILER V9.01   USB_MAIN                                                              05/05/2015 11:38:19 PAGE 2   

  53   1      }
  54          
  55          void Port_Init(void)
  56          {
  57   1              P0MDIN |= 0x40;// Port 0 pin 3 set as BUSY input
  58   1              P0MDOUT = 0xcf; //0x10 : Set TX pin to push-pull        
  59   1      
  60   1              P1MDIN |= 0xff; 
  61   1              P1MDOUT = 0x00;
  62   1              P1 |= 0xff;//Set port latches to '1'
  63   1      
  64   1              P2MDOUT = 0xf8;
  65   1              //P2 |= 0x00;
  66   1      
  67   1              P3MDIN |= 0xff; 
  68   1              P3MDOUT = 0x00;
  69   1              P3 |= 0xff;//Set port latches to '1'              
  70   1      
  71   1              XBR0 = 0x01;// Enable UART0
  72   1              XBR1 = 0x40;// Enable crossbar and weak pull-ups
  73   1      }
  74          
  75          void Oscillator_Init()
  76          {                                                               
  77   1          CLKSEL = 0x00; // Select the internal osc. as the SYSCLK source
  78   1          OSCICN = 0x83; // configure internal oscillator for 12MHz / 1
  79   1              RSTSRC = 0x04; // enable missing clock detector
  80   1      }
  81          
  82          void Suspend_Device(void)
  83          {
  84   1         // Disable peripherals before calling USB_Suspend()
  85   1         P0MDIN = 0x00;                       // Port 0 configured as analog input
  86   1         P1MDIN = 0x00;                       // Port 1 configured as analog input
  87   1         P2MDIN = 0x00;                       // Port 2 configured as analog input
  88   1         P3MDIN = 0x00;                       // Port 3 configured as analog input
  89   1      
  90   1         USB_Suspend();                       // Put the device in suspend state
  91   1      
  92   1         // Once execution returns from USB_Suspend(), device leaves suspend state.Reenable peripherals
  93   1         P0MDIN = 0xFF;
  94   1         P1MDIN = 0x7F;                       // Port 1 pin 7 set as analog input
  95   1         P2MDIN = 0xFF;
  96   1         P3MDIN = 0x01;
  97   1      }
  98          
  99          // Example ISR for USB_API
 100          void  USB_API_TEST_ISR(void) interrupt 17
 101          {
 102   1         BYTE INTVAL = Get_Interrupt_Source();
 103   1      
 104   1         if (INTVAL & RX_COMPLETE)
 105   1         {
 106   2            Block_Read(In_Packet, 2);
 107   2         }
 108   1      
 109   1         if (INTVAL & DEV_SUSPEND)
 110   1         {
 111   2              Suspend_Device();
 112   2         }
 113   1      
 114   1         if (INTVAL & DEV_CONFIGURED)
C51 COMPILER V9.01   USB_MAIN                                                              05/05/2015 11:38:19 PAGE 3   

 115   1         {
 116   2                      Oscillator_Init();
 117   2                      Port_Init();
 118   2         }
 119   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    295    ----
   CONSTANT SIZE    =     60    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     51       1
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
