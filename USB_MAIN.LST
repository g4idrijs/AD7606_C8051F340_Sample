C51 COMPILER V9.01   USB_MAIN                                                              04/29/2015 11:36:29 PAGE 1   


C51 COMPILER V9.01, COMPILATION OF MODULE USB_MAIN
OBJECT MODULE PLACED IN USB_MAIN.OBJ
COMPILER INVOKED BY: C:\Keil\C51\BIN\C51.EXE USB_MAIN.c BROWSE DEBUG OBJECTEXTEND

line level    source

   1          #include <c8051f340.h>
   2          #include <stddef.h>
   3          #include "USB_API.h"
   4          #include "C8051F340_AD7606.h"
   5          
   6          sbit Led = P2^2;                         // LED='1' means ON
   7          BYTE Out_Packet[8] = {0,0,0,0,0,0,0,0};   // Last packet received from host
   8          
   9          extern unsigned char Data[16]; //调用C8051F340――AD7606.c中的数组Date
  10          
  11          /*** [BEGIN] USB Descriptor Information [BEGIN] ***/
  12          code const UINT USB_VID = 0x10C4;
  13          code const UINT USB_PID = 0xEA61;
  14          code const BYTE USB_MfrStr[] = {0x1A,0x03,'S',0,'i',0,'l',0,'i',0,'c',0,'o',0,'n',0,' ',0,'L',0,'a',0,'b',
             -0,'s',0};                       // Manufacturer String
  15          code const BYTE USB_ProductStr[] = {0x10,0x03,'U',0,'S',0,'B',0,' ',0,'A',0,'P',0,'I',0}; // Product Desc.
             - String
  16          code const BYTE USB_SerialStr[] = {0x0A,0x03,'i',0,'d',0,'r',0,'i',0};
  17          code const BYTE USB_MaxPower = 15;            // Max current = 30 mA (15 * 2)
  18          code const BYTE USB_PwAttributes = 0x80;      // Bus-powered, remote wakeup not supported
  19          code const UINT USB_bcdDevice = 0x0100;       // Device release number 1.00
  20          /*** [ END ] USB Descriptor Information [ END ] ***/
  21          
  22          void Port_Init(void);
  23          void Suspend_Device(void);
  24          void Initialize(void);
  25          void Oscillator_Init();
  26          
  27          void main(void)
  28          {
  29   1         PCA0MD &= ~0x40;
  30   1         Oscillator_Init();
  31   1         USB_Clock_Start();
  32   1         USB_Init(USB_VID,USB_PID,USB_MfrStr,USB_ProductStr,USB_SerialStr,USB_MaxPower,USB_PwAttributes,USB_bcdD
             -evice);
  33   1      
  34   1         Initialize();
  35   1         USB_Int_Enable();
  36   1         AD7606_Init();
  37   1       
  38   1         while (1)
  39   1         {
  40   2            if (Out_Packet[0] == 1) Led = 1;   // Update status of LED #1
  41   2            else Led = 0;
  42   2      
  43   2                AD7606_Read();
  44   2                
  45   2                Block_Write(Data, 16);
  46   2             
  47   2         }
  48   1      }
  49          
  50          void Port_Init(void)
  51          {
  52   1              P0MDOUT |= 0x1D;
C51 COMPILER V9.01   USB_MAIN                                                              04/29/2015 11:36:29 PAGE 2   

  53   1              P0MDIN |= 0x02;
  54   1              P1MDOUT = 0x00;
  55   1              P1MDIN |= 0xff;
  56   1              P2MDOUT |= 0x02;
  57   1              P3MDOUT = 0x00;
  58   1              P3MDIN |= 0xff;  
  59   1      
  60   1              XBR0 = 0x00;
  61   1              XBR1 = 0x40; // Enable Crossbar
  62   1      }
  63          
  64          void Oscillator_Init()
  65          {
  66   1          int i = 0;
  67   1          FLSCL     = 0x90;
  68   1          CLKMUL    = 0x80;
  69   1          for (i = 0; i < 20; i++);    // Wait 5us for initialization
  70   1          CLKMUL    |= 0xC0;
  71   1          while ((CLKMUL & 0x20) == 0);
  72   1          CLKSEL    = 0x03;
  73   1          OSCICN    = 0x83;
  74   1      }
  75          
  76          void Suspend_Device(void)
  77          {
  78   1         // Disable peripherals before calling USB_Suspend()
  79   1         P0MDIN = 0x00;                       // Port 0 configured as analog input
  80   1         P1MDIN = 0x00;                       // Port 1 configured as analog input
  81   1         P2MDIN = 0x00;                       // Port 2 configured as analog input
  82   1         P3MDIN = 0x00;                       // Port 3 configured as analog input
  83   1      
  84   1         USB_Suspend();                       // Put the device in suspend state
  85   1      
  86   1         // Once execution returns from USB_Suspend(), device leaves suspend state.
  87   1         // Reenable peripherals
  88   1         P0MDIN = 0xFF;
  89   1         P1MDIN = 0x7F;                       // Port 1 pin 7 set as analog input
  90   1         P2MDIN = 0xFF;
  91   1         P3MDIN = 0x01;
  92   1      }
  93          
  94          //-------------------------
  95          // Initialize
  96          //-------------------------
  97          // Called when a DEV_CONFIGURED interrupt is received.
  98          // - Enables all peripherals needed for the application
  99          //
 100          void Initialize(void)
 101          {
 102   1         Port_Init();                           // Initialize crossbar and GPIO
 103   1         //Timer_Init();                          // Initialize timer2
 104   1         //Adc_Init();                            // Initialize ADC
 105   1      }
 106          
 107          // Example ISR for USB_API
 108          void  USB_API_TEST_ISR(void) interrupt 17
 109          {
 110   1         BYTE INTVAL = Get_Interrupt_Source();
 111   1      
 112   1         if (INTVAL & RX_COMPLETE)
 113   1         {
 114   2            Block_Read(Out_Packet, 8);
C51 COMPILER V9.01   USB_MAIN                                                              04/29/2015 11:36:29 PAGE 3   

 115   2         }
 116   1      
 117   1         if (INTVAL & DEV_SUSPEND)
 118   1         {
 119   2              Suspend_Device();
 120   2         }
 121   1      
 122   1         if (INTVAL & DEV_CONFIGURED)
 123   1         {
 124   2            Initialize();
 125   2         }
 126   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    319    ----
   CONSTANT SIZE    =     60    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =      8       1
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
